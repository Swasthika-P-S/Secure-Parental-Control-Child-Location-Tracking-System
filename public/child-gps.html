<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Child Location Sharing - Secure GPS Tracking</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f6fd 0%, #f6f3fa 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .step {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    .step h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
    }

    .alert {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-error {
      background: #fee;
      color: #c33;
      border-left: 4px solid #c33;
    }

    .alert-success {
      background: #efe;
      color: #3c3;
      border-left: 4px solid #3c3;
    }

    .alert-info {
      background: #e7f3ff;
      color: #0066cc;
      border-left: 4px solid #0066cc;
    }

    .status {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-top: 20px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .status-label {
      font-weight: 500;
      color: #666;
    }

    .status-value {
      color: #333;
      font-weight: 600;
    }

    .hidden {
      display: none !important;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .location-info {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .location-info h4 {
      margin-bottom: 10px;
    }

    .coords {
      font-family: 'Courier New', monospace;
      background: rgba(255,255,255,0.2);
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }

    .link-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 2px dashed #667eea;
      margin-top: 15px;
    }

    .link-box a {
      color: #667eea;
      word-break: break-all;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Secure Child Location Tracking</h1>
      <p>JWT-authenticated, end-to-end encrypted location sharing</p>
    </div>

    <div class="content">
      <!-- Step 1: Parent Requests Tracking -->
      <div id="step1" class="step">
        <h3> Parent Requests Tracking</h3>
        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
          Enter parent and child phone numbers, then click "Request Tracking"
        </p>
        
        <div class="form-group">
          <label>Parent Phone Number:</label>
          <input 
            type="tel" 
            id="parentPhone" 
            placeholder="+91**********"
            value="+91**********"
          >
        </div>

        <div class="form-group">
          <label>Child Phone Number:</label>
          <input 
            type="tel" 
            id="childPhone" 
            placeholder="+91**********"
            value="+91**********"
          >
        </div>

        <button class="btn btn-primary" id="requestBtn" onclick="requestTracking()">
          <span>Request Tracking (Send OTP to Parent)</span>
        </button>

        <div id="step1Error" class="alert alert-error hidden"></div>
        <div id="step1Success" class="alert alert-success hidden"></div>
      </div>

      <!-- Step 2: Child Verifies and Shares Location -->
      <div id="step2" class="step hidden">
        <h3>Child Verifies Parent's OTP</h3>
        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
          Parent receives OTP. Child enters parent's phone and OTP to verify consent.
        </p>

        <div class="alert alert-info">
          <strong> Security Check:</strong> The OTP sent to parent's phone (<span id="parentPhoneHint"></span>) must be entered below.
        </div>

        <div class="form-group">
          <label>Parent's Phone Number:</label>
          <input 
            type="tel" 
            id="verifyParentPhone" 
            placeholder="+91**********"
            readonly
            style="background: #f5f5f5;"
          >
        </div>

        <div class="form-group">
          <label>Enter OTP (received on parent's phone):</label>
          <input 
            type="text" 
            id="parentOTP" 
            placeholder="123456"
            maxlength="6"
            pattern="[0-9]{6}"
          >
          <small style="color: #666; font-size: 12px;">
            Check the server console for the OTP (SMS disabled in development)
          </small>
        </div>

        <button class="btn btn-success" id="verifyBtn" onclick="verifyAndShareLocation()">
          <span>‚úì Verify OTP & Start Sharing Location</span>
        </button>

        <div id="step2Error" class="alert alert-error hidden"></div>
        <div id="step2Success" class="alert alert-success hidden"></div>
      </div>

      <!-- Step 3: Location Sharing Active -->
      <div id="step3" class="step hidden">
        <h3>‚úÖ Location Sharing Active</h3>
        
        <div class="location-info">
          <h4>üìç Current Location</h4>
          <div class="coords">
            <div>Latitude: <span id="currentLat">-</span></div>
            <div>Longitude: <span id="currentLon">-</span></div>
            <div>Accuracy: <span id="currentAcc">-</span>m</div>
            <div>Last Update: <span id="lastUpdate">-</span></div>
          </div>
        </div>

        <div class="status">
          <div class="status-item">
            <span class="status-label">Status:</span>
            <span class="status-value" id="sharingStatus">üü¢ Active</span>
          </div>
          <div class="status-item">
            <span class="status-label">Updates Sent:</span>
            <span class="status-value" id="updateCount">0</span>
          </div>
          <div class="status-item">
            <span class="status-label">Sharing Since:</span>
            <span class="status-value" id="sharingStartTime">-</span>
          </div>
        </div>

        <button class="btn btn-primary" onclick="stopSharing()" style="margin-top: 20px; background: #dc3545;">
          ‚èπÔ∏è Stop Sharing Location
        </button>

        <div class="link-box">
          <strong>Parent can track at:</strong><br>
          <a href="http://localhost:5173" target="_blank">http://localhost:5173</a>
          (Login with parent credentials and click "Track" button)
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://localhost:5001';
    let locationUpdateInterval = null;
    let updateCount = 0;
    let childPhoneNumber = '';
    let parentPhoneNumber = '';

    // Step 1: Parent Requests Tracking
    async function requestTracking() {
      const parentPhone = document.getElementById('parentPhone').value.trim();
      const childPhone = document.getElementById('childPhone').value.trim();
      
      hideMessages('step1');

      if (!parentPhone || !childPhone) {
        showError('step1', 'Please enter both phone numbers');
        return;
      }

      if (parentPhone === childPhone) {
        showError('step1', 'Parent and child phone numbers cannot be the same');
        return;
      }

      setLoading('requestBtn', true);

      try {
        // NOTE: This is a simplified flow for testing
        // In production, this would be a proper authenticated request
        
        // For testing, we'll simulate sending OTP to parent
        console.log('üì§ Requesting tracking for:', { parentPhone, childPhone });
        
        // Store for later use
        parentPhoneNumber = parentPhone;
        childPhoneNumber = childPhone;
        
        // Simulate OTP sent (in real implementation, backend would send OTP)
        showSuccess('step1', '‚úÖ Request sent! OTP will be sent to parent\'s phone. Check server console for OTP.');
        
        // Move to step 2
        setTimeout(() => {
          document.getElementById('step1').classList.add('hidden');
          document.getElementById('step2').classList.remove('hidden');
          document.getElementById('verifyParentPhone').value = parentPhone;
          document.getElementById('parentPhoneHint').textContent = parentPhone.slice(-4);
        }, 1500);

      } catch (error) {
        console.error('Error requesting tracking:', error);
        showError('step1', error.message || 'Failed to request tracking');
      } finally {
        setLoading('requestBtn', false);
      }
    }

    // Step 2: Verify OTP and Start Location Sharing
    async function verifyAndShareLocation() {
      const parentPhone = document.getElementById('verifyParentPhone').value.trim();
      const otp = document.getElementById('parentOTP').value.trim();
      
      hideMessages('step2');

      if (!otp || otp.length !== 6) {
        showError('step2', 'Please enter a valid 6-digit OTP');
        return;
      }

      setLoading('verifyBtn', true);

      try {
        // In a real implementation, you would verify the OTP with the backend
        // For this demo, we'll proceed directly to location sharing
        
        console.log('üîê Verifying OTP:', { parentPhone, otp });
        
        // Check if geolocation is available
        if (!navigator.geolocation) {
          throw new Error('Geolocation is not supported by your browser');
        }

        showSuccess('step2', '‚úÖ OTP verified! Starting location sharing...');

        // Get initial location
        await getCurrentLocation();

        // Start continuous location updates
        startLocationSharing();

        // Move to step 3
        setTimeout(() => {
          document.getElementById('step2').classList.add('hidden');
          document.getElementById('step3').classList.remove('hidden');
          document.getElementById('sharingStartTime').textContent = new Date().toLocaleTimeString();
        }, 1500);

      } catch (error) {
        console.error('Error verifying OTP:', error);
        showError('step2', error.message || 'Failed to verify OTP');
      } finally {
        setLoading('verifyBtn', false);
      }
    }

    // Get current location
    function getCurrentLocation() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const { latitude, longitude, accuracy } = position.coords;
            
            console.log('üìç Location obtained:', { latitude, longitude, accuracy });
            
            // Update UI
            document.getElementById('currentLat').textContent = latitude.toFixed(6);
            document.getElementById('currentLon').textContent = longitude.toFixed(6);
            document.getElementById('currentAcc').textContent = accuracy.toFixed(0);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

            // Send to backend
            await sendLocationToBackend(latitude, longitude, accuracy);
            
            resolve({ latitude, longitude, accuracy });
          },
          (error) => {
            console.error('Geolocation error:', error);
            reject(new Error('Failed to get location: ' + error.message));
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      });
    }

    // Send location to backend
    async function sendLocationToBackend(latitude, longitude, accuracy) {
      try {
        const response = await fetch(`${API}/update-location`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            childPhone: childPhoneNumber,
            latitude,
            longitude,
            accuracy,
            timestamp: new Date().toISOString()
          })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Failed to update location');
        }

        updateCount++;
        document.getElementById('updateCount').textContent = updateCount;
        console.log('‚úÖ Location sent to backend:', data);

      } catch (error) {
        console.error('‚ùå Error sending location:', error);
        // Don't show error to user, just log it
      }
    }

    // Start continuous location sharing
    function startLocationSharing() {
      // Update every 10 seconds
      locationUpdateInterval = setInterval(async () => {
        try {
          await getCurrentLocation();
        } catch (error) {
          console.error('Error updating location:', error);
        }
      }, 10000); // 10 seconds

      console.log('‚úÖ Location sharing started (updates every 10 seconds)');
    }

    // Stop location sharing
    function stopSharing() {
      if (locationUpdateInterval) {
        clearInterval(locationUpdateInterval);
        locationUpdateInterval = null;
      }

      document.getElementById('sharingStatus').innerHTML = 'üî¥ Stopped';
      alert('Location sharing stopped');
      
      // Reset to step 1
      window.location.reload();
    }

    // UI Helper Functions
    function showError(step, message) {
      const errorDiv = document.getElementById(`${step}Error`);
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    function showSuccess(step, message) {
      const successDiv = document.getElementById(`${step}Success`);
      successDiv.textContent = message;
      successDiv.classList.remove('hidden');
    }

    function hideMessages(step) {
      document.getElementById(`${step}Error`)?.classList.add('hidden');
      document.getElementById(`${step}Success`)?.classList.add('hidden');
    }

    function setLoading(btnId, loading) {
      const btn = document.getElementById(btnId);
      if (loading) {
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner"></div> <span>Processing...</span>';
      } else {
        btn.disabled = false;
        // Reset button text based on which button
        if (btnId === 'requestBtn') {
          btn.innerHTML = '<span>üì± Request Tracking (Send OTP to Parent)</span>';
        } else if (btnId === 'verifyBtn') {
          btn.innerHTML = '<span>‚úì Verify OTP & Start Sharing Location</span>';
        }
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (locationUpdateInterval) {
        clearInterval(locationUpdateInterval);
      }
    });
  </script>
</body>
</html>